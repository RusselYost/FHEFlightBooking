# 部署检查清单

## 📋 部署前准备

### 环境配置
- [ ] 复制 `.env.example` 为 `.env`
- [ ] 配置 `PRIVATE_KEY` (部署者私钥)
- [ ] 配置 `RPC_URL` (Sepolia Infura/Alchemy 端点)
- [ ] 配置 `ETHERSCAN_API_KEY` (用于合约验证)
- [ ] 确保部署账户有足够的 SepoliaETH

### KMS 和网关配置
- [ ] 获取或部署 KMS Generation 合约地址
- [ ] 配置 `KMS_GENERATION_ADDRESS`
- [ ] 获取 Gateway 合约地址
- [ ] 配置 `GATEWAY_CONTRACT_ADDRESS`
- [ ] 获取 Decryption 合约地址
- [ ] 配置 `DECRYPTION_CONTRACT_ADDRESS`

### 暂停器配置
- [ ] 确定 KMS 节点数量 (`n_kms`)
- [ ] 确定协处理器数量 (`n_copro`)
- [ ] 计算 `NUM_PAUSERS = n_kms + n_copro`
- [ ] 配置所有 `PAUSER_ADDRESS_[0-N]` 地址
- [ ] 验证所有暂停器地址格式正确

---

## 🚀 部署步骤

### 1. 安装依赖
```bash
npm install
```
- [ ] 依赖安装成功
- [ ] 检查 `@fhevm/solidity` 版本 >= 0.5.0

### 2. 编译合约
```bash
npm run compile
```
- [ ] `ConfidentialFlightBooking.sol` 编译成功
- [ ] `PauserSet.sol` 编译成功
- [ ] 无编译警告或错误

### 3. 部署 PauserSet 合约
```bash
npm run deploy:pauser
```
- [ ] PauserSet 合约部署成功
- [ ] 记录合约地址: `_________________`
- [ ] 验证暂停器数量正确
- [ ] 验证所有暂停器地址已配置

### 4. 更新配置
- [ ] 将 PauserSet 地址添加到 `.env`
- [ ] 更新 `public/config.js` 中的配置
- [ ] 提交配置更新

### 5. 部署主合约
```bash
npm run deploy
```
- [ ] ConfidentialFlightBooking 部署成功
- [ ] 记录合约地址: `_________________`
- [ ] 验证 owner 地址正确
- [ ] 验证初始状态正确

### 6. 验证合约
```bash
npx hardhat verify --network sepolia <CONTRACT_ADDRESS>
```
- [ ] PauserSet 合约已在 Etherscan 验证
- [ ] ConfidentialFlightBooking 已在 Etherscan 验证
- [ ] 合约代码可在区块浏览器查看

---

## 🧪 部署后测试

### 基础功能测试
- [ ] 连接 MetaMask 钱包成功
- [ ] 正确显示连接状态
- [ ] 可以读取合约数据

### 航班管理测试
- [ ] 添加测试航班
- [ ] 航班显示在列表中
- [ ] 航班信息正确显示
- [ ] 可以更新航班状态

### 预订功能测试
- [ ] 创建测试预订
- [ ] 预订显示在"我的预订"中
- [ ] 加密数据正确处理
- [ ] 座位分配正常工作

### 加密功能测试
- [ ] 护照号码加密
- [ ] 年龄加密
- [ ] 座位号加密
- [ ] 支付金额加密
- [ ] 权限配置正确

### 暂停功能测试
- [ ] 授权暂停器可以暂停合约
- [ ] 暂停状态正确反映
- [ ] 暂停时操作被阻止
- [ ] 可以恢复合约

---

## 🔐 安全检查

### 合约安全
- [ ] Owner 地址正确
- [ ] 暂停器配置正确
- [ ] 权限管理适当
- [ ] 无已知安全漏洞

### 密钥管理
- [ ] 私钥安全存储
- [ ] 不在代码库中提交私钥
- [ ] `.env` 文件在 `.gitignore` 中
- [ ] 使用环境变量管理敏感信息

### 前端安全
- [ ] 合约地址正确配置
- [ ] RPC 端点使用 HTTPS
- [ ] 用户输入验证
- [ ] 错误处理适当

---

## 📝 文档更新

### 合约地址更新
- [ ] 更新 `README.md` 中的合约地址
- [ ] 更新 `public/config.js`
- [ ] 更新 `.env.example` 示例值
- [ ] 提交文档更新

### 部署信息记录
- [ ] 记录部署时间戳
- [ ] 记录部署交易哈希
- [ ] 记录所有合约地址
- [ ] 保存部署日志

### 前端配置
- [ ] 更新合约地址
- [ ] 配置网络参数
- [ ] 测试前端连接
- [ ] 部署到生产环境

---

## 🌐 生产部署

### Vercel 部署
- [ ] 配置 Vercel 项目
- [ ] 设置环境变量
- [ ] 部署到生产环境
- [ ] 验证生产环境功能
- [ ] 配置自定义域名(可选)

### 性能优化
- [ ] 启用前端缓存
- [ ] 优化资源加载
- [ ] 配置 CDN(可选)
- [ ] 监控性能指标

---

## 📊 监控和维护

### 合约监控
- [ ] 设置交易监控
- [ ] 配置事件监听
- [ ] 监控 gas 使用
- [ ] 追踪用户活动

### 错误追踪
- [ ] 配置错误日志
- [ ] 设置告警机制
- [ ] 定期检查日志
- [ ] 及时响应问题

### 定期维护
- [ ] 定期检查合约状态
- [ ] 监控暂停器地址
- [ ] 更新依赖版本
- [ ] 审查安全公告

---

## ✅ 最终验证

### 功能完整性
- [ ] 所有核心功能正常工作
- [ ] 加密功能正确实现
- [ ] 用户体验流畅
- [ ] 无严重 bug

### 文档完整性
- [ ] 所有文档已更新
- [ ] 部署信息已记录
- [ ] 使用说明清晰
- [ ] 示例代码正确

### 团队确认
- [ ] 技术团队审查通过
- [ ] 测试团队验证完成
- [ ] 产品团队确认满意
- [ ] 准备上线公告

---

## 📞 紧急联系

**如果遇到问题:**

1. **技术支持**
   - GitHub Issues: [项目 Issues](https://github.com/RusselYost/ConfidentialFlightBooking/issues)
   - Zama 社区: [community.zama.ai](https://community.zama.ai/)

2. **回滚计划**
   - 保存原合约地址
   - 准备回滚脚本
   - 通知用户维护

3. **故障排除**
   - 查看 `UPGRADE_NOTES.md`
   - 参考 `MIGRATION_GUIDE.md`
   - 检查部署日志

---

## 📅 部署记录

**部署日期:** __________

**部署人员:** __________

**网络:** Sepolia Testnet

**合约地址:**
- PauserSet: `_________________`
- ConfidentialFlightBooking: `_________________`

**交易哈希:**
- PauserSet: `_________________`
- ConfidentialFlightBooking: `_________________`

**验证状态:**
- PauserSet: ☐ 已验证 ☐ 未验证
- ConfidentialFlightBooking: ☐ 已验证 ☐ 未验证

**备注:**
```
_________________________________________________
_________________________________________________
_________________________________________________
```

---

**检查清单完成:** ☐ 是 ☐ 否

**批准上线:** ☐ 是 ☐ 否

**签名:** __________

**日期:** __________
